env:
  APOLLO_SERVICE_NAME: ""
  SCHEMA_FILE: ""

name: PR Checks App
on:
  pull_request_target:
    branches:
      - main 
    types: [opened, synchronize, reopened, edited, ready_for_review]

permissions:
  id-token: write
  contents: write

jobs:
  checking-parallelism:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Checking needed parallelism
    runs-on: ubuntu-latest
    outputs: 
      parallelism: ${{ steps.checking-parallelism.outputs.parallelism }}
      parallelism-merge-result: ${{ steps.checking-parallelism-merge-result.outputs.parallelism-merge-result }}
      parallelism-others: ${{ steps.checking-parallelism-others.outputs.parallelism }}
      parallelism-merge-result-others: ${{ steps.checking-parallelism-merge-result-others.outputs.parallelism-merge-result }}
      run-schema-check: ${{ steps.run-schema-check.outputs.result }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Checking parallelism
        id: checking-parallelism
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin $DEFAULT_BRANCH
          CHANGESET=$(git diff origin/$DEFAULT_BRANCH...HEAD --name-only)
          if [[ $CHANGESET =~ yarn.lock ]]; then
            echo "parallelism=[0, 1, 2, 3, 4]" >> $GITHUB_OUTPUT
          else
            echo "parallelism=[0]" >> $GITHUB_OUTPUT
          fi

      - name: Checking parallelism
        id: checking-parallelism-others
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin $DEFAULT_BRANCH
          CHANGESET=$(git diff origin/$DEFAULT_BRANCH...HEAD --name-only)
          if [[ $CHANGESET =~ yarn.lock|eslintrc|eslintignore|prettier|tsconfig ]]; then
            echo "parallelism=[0, 1, 2]" >> $GITHUB_OUTPUT
          else
            echo "parallelism=[0]" >> $GITHUB_OUTPUT
          fi

      - name: Setup branch merge result branch
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GHACTIONS_BOT_NAME: "github-actions[bot]"
          GHACTIONS_BOT_EMAIL: "<github-actions[bot]@users.noreply.github.com>"
        run: |
          git config user.name $GHACTIONS_BOT_NAME
          git config user.email $GHACTIONS_BOT_EMAIL
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch: " "$CURRENT_BRANCH"
          # Merge in the $DEFAULT_BRANCH branch
          git checkout $DEFAULT_BRANCH
          git merge --no-edit "$CURRENT_BRANCH" --allow-unrelated-histories

      - name: Checking parallelism in merge result
        id: checking-parallelism-merge-result
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin $DEFAULT_BRANCH
          CHANGESET=$(git diff origin/$DEFAULT_BRANCH...HEAD --name-only)
          if [[ $CHANGESET =~ yarn.lock ]]; then
            echo "parallelism-merge-result=[0, 1, 2, 3, 4]" >> $GITHUB_OUTPUT
          else
            echo "parallelism-merge-result=[0]" >> $GITHUB_OUTPUT
          fi
          
      - name: Checking parallelism in merge result
        id: checking-parallelism-merge-result-others
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin $DEFAULT_BRANCH
          CHANGESET=$(git diff origin/$DEFAULT_BRANCH...HEAD --name-only)
          if [[ $CHANGESET =~ yarn.lock|eslintrc|eslintignore|prettier|tsconfig ]]; then
            echo "parallelism-merge-result=[0, 1, 2]" >> $GITHUB_OUTPUT
          else
            echo "parallelism-merge-result=[0]" >> $GITHUB_OUTPUT
          fi

      - name: Check if microservice needs GraphQL schema check
        id: run-schema-check
        run: |
          if [[ "${{ env.APOLLO_SERVICE_NAME }}" == "" || "${{ env.SCHEMA_FILE }}" == "" ]]; then
            echo "result=disabled" >> $GITHUB_OUTPUT
          else
            echo "result=enabled" >> $GITHUB_OUTPUT
          fi

  test:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Test
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Test
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn test
 
  test-merge-result:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Test (merge result)
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism-merge-result) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Setup branch
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GHACTIONS_BOT_NAME: "github-actions[bot]"
          GHACTIONS_BOT_EMAIL: "<github-actions[bot]@users.noreply.github.com>"
        run: |
          git config user.name $GHACTIONS_BOT_NAME
          git config user.email $GHACTIONS_BOT_EMAIL
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch: " "$CURRENT_BRANCH"
          # Merge in the $DEFAULT_BRANCH branch
          git checkout $DEFAULT_BRANCH
          git merge --no-edit "$CURRENT_BRANCH" --allow-unrelated-histories

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Test
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn test

  test_results:
    name: Test results
    if: |
      always() &&
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    needs: [test, test-merge-result]
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${{ needs.test-merge-result.result }}" == "success" && "${{ needs.test.result }}" == "success" ]]; then  
            echo "All tests passed"
            exit 0
          else
            echo "Some tests failed"
            exit 1
          fi

  typecheck:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Typecheck 
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism-others) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Typecheck
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn typecheck

  typecheckmergeresult:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Typecheck (merge result)
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism-merge-result-others) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Setup branch
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GHACTIONS_BOT_NAME: "github-actions[bot]"
          GHACTIONS_BOT_EMAIL: "<github-actions[bot]@users.noreply.github.com>"
        run: |
          git config user.name $GHACTIONS_BOT_NAME
          git config user.email $GHACTIONS_BOT_EMAIL
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch: " "$CURRENT_BRANCH"
          # Merge in the $DEFAULT_BRANCH branch
          git checkout $DEFAULT_BRANCH
          git merge --no-edit "$CURRENT_BRANCH" --allow-unrelated-histories

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Typecheck
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn typecheck

  typecheck_results:
    if: |
      always() &&
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Typecheck results
    needs: [typecheck, typecheckmergeresult]
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${{ needs.typecheckmergeresult.result }}" == "success" && "${{ needs.typecheck.result }}" == "success" ]]; then  
            echo "All typechecks passed"
            exit 0
          else
            echo "Some typechecks failed"
            exit 1
          fi

  lint:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Check Lint
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism-others) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Check Lint
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn lint

  lintmergeresult:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Check Lint (merge result)
    needs: checking-parallelism
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: ${{ fromJson(needs.checking-parallelism.outputs.parallelism-merge-result-others) }}
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Setup branch
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GHACTIONS_BOT_NAME: "github-actions[bot]"
          GHACTIONS_BOT_EMAIL: "<github-actions[bot]@users.noreply.github.com>"
        run: |
          git config user.name $GHACTIONS_BOT_NAME
          git config user.email $GHACTIONS_BOT_EMAIL
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch: " "$CURRENT_BRANCH"
          # Merge in the $DEFAULT_BRANCH branch
          git checkout $DEFAULT_BRANCH
          git merge --no-edit "$CURRENT_BRANCH" --allow-unrelated-histories

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile

      - name: Check Lint
        env:
            DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          yarn lint

  lint_results:
    if: |
      always() &&
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Lint results
    needs: [lint, lintmergeresult]
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${{ needs.lintmergeresult.result }}" == "success" && "${{ needs.lint.result }}" == "success" ]]; then  
            echo "All lint passed"
            exit 0
          else
            echo "Some lint failed"
            exit 1
          fi

  build:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false
    name: Build
    runs-on: ubuntu-latest
    needs: checking-parallelism
    steps:
      - name: Checkout to default branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Build image
        run: |
          DOCKER_BUILDKIT=1 docker build \
            -t "build-check:check-${{ github.sha }}" \
            -f "./Dockerfile" \
            --build-arg="NPM_TOKEN=${{ secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN }}" \
            --target="prod" .

  schemacheck:
    if: |
      github.event.repository.name != 'node-ecs-template' &&
      !contains( github.event.pull_request.title, 'chore(deps)') &&
      github.event.pull_request.draft == false &&
      needs.checking-parallelism.outputs.run-schema-check == 'enabled'
    name: Microservice schema check 
    needs: checking-parallelism
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100
          ref: ${{ github.head_ref }}

      - name: Read .nvmrc
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV
  
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Lovepaign config
        run: |
          echo "unsafe-perm=true" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "registry=https://packagecloud.io/agrible/lovepaign/npm/" >> .npmrc
          echo "//packagecloud.io/agrible/lovepaign/npm/:_authToken=${{secrets.PACKAGECLOUD_LOVEPAIGN_READ_TOKEN}}" >> .npmrc

      - name: Yarn Install
        run: |
          node -v
          yarn install --cache-folder ~/.cache/yarn --frozen-lockfile
  
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.SILVER_ACC_ID }}:role/GitHubOrganizationAccountAssumeRole
          aws-region: us-east-2

      - name: Setup environment
        run: |-
          get_ssm_param() {
            aws ssm get-parameter --with-decryption --name $1 --region sa-east-1 | awk '/Value/ { print $2}' | sed 's/",*//g'
          }

          APOLLO_KEY=$(get_ssm_param ${{ vars.SSM_PATH_APOLLO_KEY_DEV }})
          echo "::add-mask::$APOLLO_KEY"
          echo "APOLLO_KEY=$APOLLO_KEY" >> $GITHUB_ENV
          
          GRAPH=$(cut -d ":" -f2 <<< "$APOLLO_KEY")
          echo "GRAPH=$GRAPH" >> $GITHUB_ENV

      - name: Install Rover
        run: |
          curl -sSL https://rover.apollo.dev/nix/v0.21.0 | sh
          echo "$HOME/.rover/bin" >> $GITHUB_PATH

      - name: Schema Check
        env:
          VARIANT: dev-br
        run: |          
          echo "... Yarn build for ${{ env.APOLLO_SERVICE_NAME }} ..."
          yarn build

          echo "... Rover subgraph check for ${{ env.APOLLO_SERVICE_NAME }} ..."
          rover subgraph check $GRAPH@$VARIANT --schema ${{ env.SCHEMA_FILE }} --name ${{ env.APOLLO_SERVICE_NAME }} --log info
